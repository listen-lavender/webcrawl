#!/usr/bin/python
# coding=utf-8
import os, sys
from docopt import docopt

proxy = """
var port, server, service,
  wait_before_end = 60000,
  system = require("system"),
  webpage = require("webpage");

function get_bytes(str, isGetBytes) {
   var back = [],
     byteSize = 0;
   for (var i = 0; i < str.length; i++) {
     var code = str.charCodeAt(i);
     if (code >= 0 && code <= 127) {
       byteSize += 1;
       back.push(code);
     } else if (code >= 128 && code <= 2047) {
       byteSize += 2;
       back.push((192 | (31 & (code >> 6))));
       back.push((128 | (63 & code)))
     } else if (code >= 2048 && code <= 65535) {
       byteSize += 3;
       back.push((224 | (15 & (code >> 12))));
       back.push((128 | (63 & (code >> 6))));
       back.push((128 | (63 & code)))
     }
   }
   for (i = 0; i < back.length; i++) {
     if (back[i] > 255) {
       back[i] &= 255
     }
   }
   if (isGetBytes) {
     return back
   }
   if (byteSize <= 255) {
     return [0, byteSize].concat(back);
   } else {
     return [byteSize >> 8, byteSize & 255].concat(back);
   }
}

if (system.args.length !== 2) {
  console.log("Usage: .js <portnumber>");
  phantom.exit(1);
} else {
  port = system.args[1];
  server = require("webserver").create();
  console.debug = function(abc){};
  // console.debug = function(abc){console.log(abc)};

  service = server.listen(port, {
    "keepAlive": true
  }, function (request, response) {
    phantom.clearCookies();

    //console.debug(JSON.stringify(request, null, 4));
    // check method
    if (request.method == "GET") {
      response.statusCode = 403;
      response.write("method not allowed!");
      response.close();
      return;
    }
    
    var fetch = JSON.parse(request.post);
    console.debug(JSON.stringify(fetch, null, 2));

    // create and set page
    var page = webpage.create();
    page.viewportSize = {
      width: 1024,
      height: 768
    }
    if (fetch.headers) {
      fetch.headers["Accept-Encoding"] = undefined;
      fetch.headers["Connection"] = undefined;
      fetch.headers["Content-Length"] = undefined;
    }
    if (fetch.headers && fetch.headers["User-Agent"]) {
      page.settings.userAgent = fetch.headers["User-Agent"];
    }
    page.settings.encoding = "utf-8";
    page.settings.webSecurityEnabled = false;
    page.settings.localToRemoteUrlAccessEnabled = true;
    page.settings.loadImages = fetch.load_images ? true : false;
    page.settings.resourceTimeout = fetch.timeout ? fetch.timeout * 1000 : 120*1000;
    if (fetch.headers) {
      page.customHeaders = fetch.headers;
    }
    
    // add callbacks
    var first_response = null,
        finished = false,
        page_loaded = false,
        start_time = Date.now(),
        end_time = null,
        script_executed = false,
        javascript_result = null;
    page.onInitialized = function() {
      if (!script_executed && fetch.javascript && fetch.runat === "start") {
        script_executed = true;
        console.log("running document-start script.");
        javascript_result = page.evaluateJavaScript(fetch.javascript);
      }
    };
    page.onLoadFinished = function(status) {
      page_loaded = true;
      if (!script_executed && fetch.javascript && fetch.runat !== "start") {
        script_executed = true;
        console.log("running document-end script.");
        javascript_result = page.evaluateJavaScript(fetch.javascript);
      }
      console.debug("waiting "+wait_before_end+"ms before finished.");
      end_time = Date.now() + wait_before_end;
      setTimeout(handle, wait_before_end+10, page);
    };
    page.onResourceRequested = function(request) {
      console.debug("Starting request: #"+request.id+" ["+request.method+"]"+request.url);
      end_time = null;
    };
    page.onResourceReceived = function(response) {
      console.debug("Request finished: #"+response.id+" ["+response.status+"]"+response.url);
      if (first_response === null && response.status != 301 && response.status != 302) {
        first_response = response;
      }
      if (page_loaded) {
        console.debug("waiting "+wait_before_end+"ms before finished.");
        end_time = Date.now() + wait_before_end;
        setTimeout(handle, wait_before_end+10, page);
      }
    }
    page.onResourceError=page.onResourceTimeout=function(response) {
      console.info("Request error: #"+response.id+" ["+response.errorCode+"="+response.errorString+"]"+response.url);
      if (first_response === null) {
        first_response = response;
      }
      if (page_loaded) {
        console.debug("waiting "+wait_before_end+"ms before finished.");
        end_time = Date.now() + wait_before_end;
        setTimeout(handle, wait_before_end+10, page);
      }
    }
    setTimeout(function(page) {
      if (first_response) {
        end_time = Date.now()-1;
        handle(page);
      }
    }, page.settings.resourceTimeout, page);

    // send request
    page.open(fetch.url, {
      operation: fetch.method,
      data: fetch.data,
      encoding: "utf8"
    });

    // make response
    function handle(page) {
      if (!!!end_time || finished) {
        return;
      }
      if (end_time > Date.now()) {
        setTimeout(handle, Date.now() - end_time, page);
        return;
      }

      var result = {};
      try {
        result = format(page);
      } catch (e) {
        result = {
          orig_url: fetch.url,
          status_code: 599,
          error: e.toString(),
          content:  "",
          headers: {},
          url: page.url,
          cookies: {},
          time: (Date.now() - start_time) / 1000,
          save: fetch.save
        }
      }

      console.log("["+result.status_code+"] "+result.orig_url+" "+result.time)

      result['content'] = result['content'].replace(new RegExp('"', 'gm'), "'");
      var body = unescape(JSON.stringify(result, null, 2));
      var body_length = get_bytes(body, true).length;
      response.statusCode = 200;
      response.headers = {
        "Cache": "no-cache",
        "Content-Type": "application/json",
        "Connection": "Keep-Alive",
        "Keep-Alive": "timeout=5, max=100",
        "Content-Length": body_length
      };
      response.setEncoding("utf-8");
      response.write(body);
      response.close();
      finished = true;
      page.close();
    }

    function format(page) {
      var cookies = {};
      page.cookies.forEach(function(e) {
        cookies[e.name] = e.value;
      });

      var headers = {};
      if (first_response.headers) {
        first_response.headers.forEach(function(e) {
          headers[e.name] = e.value;
        });
      }

      return {
        orig_url: fetch.url,
        status_code: first_response.status || 599,
        error: first_response.errorString,
        content:  page.content,
        headers: headers,
        url: page.url,
        cookies: cookies,
        time: (Date.now() - start_time) / 1000,
        javascript_result: javascript_result,
        save: fetch.save
      }
    }
  });

  if (service) {
    console.log("Web server running on port " + port);
  } else {
    console.log("Error: Could not create web server listening on port " + port);
    phantom.exit();
  }
}
"""

if __name__ == '__main__':
    helpdoc = """Tools to use phantomjs(a headless WebKit scriptable with a JavaScript API) conviently.
    Usage:
      browse (-h|--help)
      browse (-p|--port) <port>

    Options:
      -h,  --help        Show help document.
      -p,  --port        Port for phantomjs server.
    """
    path = '/tmp/proxy.js'
    params = docopt(helpdoc)
    if params.get('<port>'):
        f = open(path, 'w')
        f.write(proxy)
        f.close()
        os.system('phantomjs %s %s' % (path, params.get('<port>')))
    else:
        pass